version: 2.1

commands:
  add-ubuntugis-ppa:
    parameters:
      archive: &ubuntugis-parameter
        type: enum
        enum:
          - stable
          - unstable
          - ""
        default: ""

    steps:
      - run:
          name: Add ubuntugis PPA
          command: |
            apt-get update && apt-get install -y software-properties-common
            if [[ "<< parameters.archive >>" = "stable" ]]
            then
              archive='ppa'
            else
              archive='ubuntugis-unstable'
            fi
            add-apt-repository -y ppa:ubuntugis/${archive}

  install-system-packages:
    steps:
      - run:
          name: Install most system packages
          command: |
            apt-get update && apt-get install -y \
              libgdal-dev \
              gdal-bin \
              libtiff5 \
              optipng \
              pngquant \
              python3-pip \

      - run:
          name: Install libvips
          command: |
            apt-get install -y --no-install-recommends \
              libvips \
              libvips-dev \

  run-tox-tests:
    parameters:
      tox: &tox-parameter
        type: enum
        enum:
          - py2
          - py3
          - vips
        default: py3

    steps:
      - checkout
      - run:
          name: Run tox tests
          command: |
            python3 -m pip install tox
            GDAL_VERSION=$(gdal-config --version) tox -e << parameters.tox >> -- "-m not skip_on_ci"

executors:
  xenial:
    docker:
      - image: ubuntu:xenial
    resource_class: small

  bionic:
    docker:
      - image: ubuntu:bionic
    resource_class: small

  focal:
    docker:
      - image: ubuntu:focal
    resource_class: small

jobs:
  test:
    parameters:
      executor:
        type: executor
      ubuntugis:
        <<: *ubuntugis-parameter
      tox:
        <<: *tox-parameter

    executor: << parameters.executor >>
    steps:
      - when:
          condition: << parameters.ubuntugis >>
          steps:
            - add-ubuntugis-ppa:
                archive: << parameters.ubuntugis >>
      - install-system-packages
      - run-tox-tests:
          tox: << parameters.tox >>

workflows:
  version: 2

  xenial:
    jobs:
      - test:
          name: test-xenial-py2
          executor: xenial
          tox: py2

      - test:
          name: test-xenial
          executor: xenial

      - test:
          name: test-xenial-stablegis
          executor: xenial
          ubuntugis: stable

      - test:
          name: test-xenial-unstablegis
          executor: xenial
          ubuntugis: unstable

  bionic:
    jobs:
      - test:
          name: test-bionic-vips
          executor: bionic
          tox: vips

      - test:
          name: test-bionic
          executor: bionic

      - test:
          name: test-bionic-stablegis
          executor: bionic
          ubuntugis: stable

      - test:
          name: test-bionic-unstablegis
          executor: bionic
          ubuntugis: unstable

  focal:
    jobs:
      - test:
          name: test-focal
          executor: focal


# TODO lint the parameter aliases and tox envs
